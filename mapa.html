<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <link rel="icon" href="dist/img/logo-cmvc.png" type="image/x-icon" />
    <title>CMVC</title>
    <script type="text/javascript">
      if(!localStorage.getItem('tok')){
        setTimeout(function() {document.location.href = "/cmvc/index.html";}, 0);
      }
  </script>
    <!-- Tell the browser to be responsive to screen width -->
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="plugins/fontawesome-free/css/all.min.css">
    <!-- Ionicons -->
    <link rel="stylesheet" href="https://code.ionicframework.com/ionicons/2.0.1/css/ionicons.min.css">
    <!-- Tempusdominus Bbootstrap 4 -->
    <link rel="stylesheet" href="plugins/tempusdominus-bootstrap-4/css/tempusdominus-bootstrap-4.min.css">
    <!-- iCheck -->
    <link rel="stylesheet" href="plugins/icheck-bootstrap/icheck-bootstrap.min.css">
    <!-- JQVMap -->
    <link rel="stylesheet" href="plugins/jqvmap/jqvmap.min.css">
    <!-- Theme style -->
    <link rel="stylesheet" href="dist/css/adminlte.min.css">
    <link rel="stylesheet" href="plugins/toastr/toastr.min.css" />
    <!-- overlayScrollbars -->
    <link rel="stylesheet" href="plugins/overlayScrollbars/css/OverlayScrollbars.min.css">
    <!-- Daterange picker -->
    <link rel="stylesheet" href="plugins/daterangepicker/daterangepicker.css">
    <link rel="stylesheet" href="dist/css/datepicker.min.css">
    <!-- summernote -->
    <link rel="stylesheet" href="plugins/summernote/summernote-bs4.css">
    <!-- Google Font: Source Sans Pro -->
    <link href="https://fonts.googleapis.com/css?family=Source+Sans+Pro:300,400,400i,700" rel="stylesheet">

    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.6.0/dist/leaflet.css"
   integrity="sha512-xwE/Az9zrjBIphAcBb3F6JVqxf46+CDLwfLMHloNu6KEQCAWi6HcDUbeOfBIptF7tcCzusKFjFw2yuvEpDL9wQ=="
   crossorigin=""/>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <link rel="stylesheet" href="dist/css/L.Control.Sidebar.css">

    <link rel="stylesheet" href="dist/css/map.css" type="text/css">

    <script src="https://unpkg.com/leaflet@1.6.0/dist/leaflet.js"
    integrity="sha512-gZwIG9x3wUXg2hdXF6+rVkLF/0Vi9U8D2Ntg4Ga5I5BZpVkVxlJWbSQtXPSiUTtC0TjtGOmxa1AJPuV0CPthew=="
    crossorigin=""></script>

    <script src="dist/js/L.Control.Sidebar.js"></script>    
    <script src="dist/js/Leaflet.draw.js"></script>

  </head>
<body class="hold-transition sidebar-mini sidebar-collapse">
<!-- Site wrapper -->
<div class="wrapper">
  <!-- Navbar -->
  <nav class="main-header navbar navbar-expand navbar-lightblue navbar-light">
    <!-- Right navbar links -->
    <ul class="navbar-nav ml-auto">
      <!-- Notifications Dropdown Menu -->
      <li class="nav-item dropdown">
        <a class="nav-link" data-toggle="dropdown" href="#">
          <i class="far fa-bell"></i>
          <span class="badge badge-warning navbar-badge">15</span>
        </a>
        <div class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <span class="dropdown-item dropdown-header">15 Notifications</span>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-envelope mr-2"></i> 4 new messages
            <span class="float-right text-muted text-sm">3 mins</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-users mr-2"></i> 8 friend requests
            <span class="float-right text-muted text-sm">12 hours</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item">
            <i class="fas fa-file mr-2"></i> 3 new reports
            <span class="float-right text-muted text-sm">2 days</span>
          </a>
          <div class="dropdown-divider"></div>
          <a href="#" class="dropdown-item dropdown-footer">See All Notifications</a>
        </div>
      </li>
      <li class="nav-item dropdown user-menu">
        <a href="#" class="nav-link dropdown-toggle" data-toggle="dropdown">
          <img src="dist/img/user2-160x160.jpg" class="user-image img-circle elevation-2" alt="User Image">
          <span class="d-none d-md-inline">Pedro Martins</span>
        </a>
        <ul class="dropdown-menu dropdown-menu-lg dropdown-menu-right">
          <!-- User image -->
          <li class="user-header bg-primary">
            <img src="dist/img/user2-160x160.jpg" class="img-circle elevation-2" alt="User Image">

            <p>
              Pedro Martins
              <small>Membro desde Nov. 2020</small>
            </p>
          </li>
          <!-- Menu Footer-->
          <li class="user-footer">
            <a href="/cmvc/perfil.html" class="btn btn-default btn-flat">Perfil</a>
            <button class="btn btn-default btn-flat float-right" id="signout">Logout</button>
          </li>
        </ul>
      </li>
    </ul>
  </nav>
  <!-- /.navbar -->

  <!-- Main Sidebar Container -->
  <aside class="main-sidebar sidebar-dark-lightblue elevation-4">
    <!-- Brand Logo -->
    <a href="/cmvc/index.html" class="brand-link">
      <img src="dist/img/logo-cmvc.png"
           alt="Logo CMVC"
           class="brand-image img-circle elevation-3"
           style="opacity: 0.8">
      <span class="brand-text font-weight-light">CMVC</span>
    </a>

    <!-- Sidebar -->
    <div class="sidebar sidebar-dark-lightblue">
      <!-- Sidebar Menu -->
      <nav class="mt-2">
        <ul class="nav nav-pills nav-sidebar flex-column" data-widget="treeview" role="menu" data-accordion="false">
          <!-- Add icons to the links using the .nav-icon class
               with font-awesome or any other icon font library -->
          <li class="nav-item has-treeview">
            <a href="/cmvc/mapa.html" class="nav-link active">
              <i class="nav-icon fas fa-map-marked-alt"></i>
              <p>
                Mapa
              </p>
            </a>
          </li>
          <li class="nav-item has-treeview">
            <a href="#" class="nav-link">
              <i class="nav-icon fas fa-table"></i>
              <p>
                Backoffice
                <i class="fas fa-angle-left right"></i>
              </p>
            </a>
            <ul class="nav nav-treeview">
              <li class="nav-item">
                <a href="/cmvc/sensores.html" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Sensores</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/cmvc/poligonos.html" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Polígonos</p>
                </a>
              </li>
              <li class="nav-item">
                <a href="/cmvc/users.html" class="nav-link">
                  <i class="far fa-circle nav-icon"></i>
                  <p>Utilizadores</p>
                </a>
              </li>
            </ul>
          </li>
        </ul>
        
      </nav>
      <!-- /.sidebar-menu -->
    </div>
    <!-- /.sidebar -->
  </aside>

  <!-- Content Wrapper. Contains page content -->
  <div class="content-wrapper">
    <!-- Content Header (Page header) -->
    <section class="content-header">
      <div class="container-fluid">
        <div class="row mb-2">
          <div class="col-sm-3">
            <h1>Mapa</h1>
          </div>
          <div class="col-sm-3">           
              <div class="custom-control custom-switch">
              <input type="checkbox" class="custom-control-input" id="editMode">
              <label class="custom-control-label" for="editMode">Modo Edição</label>
            </div>
          </div>
          <div class="col-sm-6">
            <ol class="breadcrumb float-sm-right">
                <li class="breadcrumb-item"><a href="/cmvc/index.html">Home</a></li>
                <li class="breadcrumb-item active">Mapa</li>
            </ol>
          </div>
        </div>
      </div><!-- /.container-fluid -->
    </section>

    <!-- Main content -->
    <section class="content">
            <div id="sidebar">
                <h4>Sensor tipo: </h4>
                <div id="graphArea">
                </div>
            </div>
        <div id="map" class="map"></div>
    </section>



    <!-- /.content -->
  </div>
  <!-- /.content-wrapper -->

  <footer class="main-footer text-sm">
    <div class="float-right d-none d-sm-block">
      Copyright &copy; CMVC PM 2020. All rights reserved.
    </div>
  </footer>

  <div class="modal fade" id="modal-add">
    <div class="modal-dialog modal-lg">
      <div class="modal-content">
        <div class="modal-header">
          <h4 class="modal-title">Adicionar Medição</h4>
          <button type="button" class="close" data-dismiss="modal" aria-label="Close">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <form role="form" id="addMeasurement">
            <div class="row">
              <div class="col-sm-6">
                <!-- text input -->
                <div class="form-group">
                  <label>Sensor</label>
                  <select class="form-control" id="addSensor" name="addSensor" style="width: 100%;">
                    
                  </select>
                </div>
              </div>
              <div class="col-sm-6">
              <!-- Date -->
              <div class="form-group">
                  <label>Data de Início</label>  
                  <div class="input-group date">
                    <input type="text" class="form-control pull-right" id="datepicker" name="datepicker">
                  </div>
                  <!-- /.input group -->
                </div>
                <!-- /.form group -->
                </div>
            </div>
            <div class="row">
              <div class="col-sm-12">
                <!-- text input -->
                <div class="form-group">
                  <label>Descrição</label>
                  <textarea class="form-control" rows="3" id="description" name="description" class="form-control" placeholder="Descrição da medição..."></textarea>
                </div>
              </div>
            </div>
            <div class="row">
              <div class="col-sm-6">
                <label>Latitude
                </label>
                <input type="text" class="form-control" name="lat" id="lat" placeholder="Latitude..." disabled>
              </div>
              <div class="col-sm-6">
                <label>Longitude
                </label>
                <input type="text" class="form-control" name="lon" id="lon" placeholder="Longitude..." disabled>
              </div>
            </div>
        <div class="modal-footer justify-content-between">
          <button type="button" class="btn btn-default" data-dismiss="modal">Fechar</button>
          <button type="submit" class="btn btn-primary" id="save">Guardar</button>
        </div>
      </form>   
      </div>
    </div>
  </div>

  <!-- Control Sidebar -->
  <aside class="control-sidebar control-sidebar-dark">
    <!-- Control sidebar content goes here -->
  </aside>
  <!-- /.control-sidebar -->
</div>
<!-- ./wrapper -->

<!-- jQuery -->
<script src="plugins/jquery/jquery.min.js"></script>
<!-- jQuery UI 1.11.4 -->
<script src="plugins/jquery-ui/jquery-ui.min.js"></script>
<!-- Resolve conflict in jQuery UI tooltip with Bootstrap tooltip -->
<script>
  $.widget.bridge('uibutton', $.ui.button)
</script>
<!-- Bootstrap 4 -->
<script src="plugins/bootstrap/js/bootstrap.bundle.min.js"></script>
<!-- daterangepicker -->
<script src="plugins/moment/moment.min.js"></script>
<script src="plugins/daterangepicker/daterangepicker.js"></script>
<script src="dist/js/datepicker.min.js"></script>
<script src="plugins/moment/moment-with-locales.min.js"></script>
<!-- Tempusdominus Bootstrap 4 -->
<script src="plugins/tempusdominus-bootstrap-4/js/tempusdominus-bootstrap-4.min.js"></script>
<!-- Summernote -->
<script src="plugins/summernote/summernote-bs4.min.js"></script>
<!-- overlayScrollbars -->
<script src="plugins/overlayScrollbars/js/jquery.overlayScrollbars.min.js"></script>
<!-- AdminLTE App -->
<script src="plugins/sweetalert2/sweetalert2.min.js"></script>
<script src="plugins/toastr/toastr.min.js"></script>
<script src="dist/js/adminlte.js"></script>

<script src="https://cdn.jsdelivr.net/npm/js-cookie@rc/dist/js.cookie.min.js"></script>
<!-- jquery-validation -->
<script src="plugins/jquery-validation/jquery.validate.min.js"></script>
<script src="plugins/jquery-validation/additional-methods.min.js"></script>

<script src="dist/js/maps.js"></script>
<!-- Axios -->
<script src="dist/js/axios.min.js"></script>
</body>
</html>

<script>
   $(function() {
     getUser();
     getSensores();

     $('#datepicker').datepicker({
      autoclose: true,
      todayHighlight: true,
      format: 'dd/mm/yyyy',
      endDate: new Date(),
      language: 'pt-BR'
    });

    var data = new Date(),
        dia  = data.getDate().toString().padStart(2, '0'),
        mes  = (data.getMonth()+1).toString().padStart(2, '0'), //+1 pois no getMonth Janeiro começa com zero.
        ano  = data.getFullYear();
    $("#datepicker").val(dia+"/"+mes+"/"+ano);


  const Toast = Swal.mixin({
    toast: true,
    position: "top-end",
    showConfirmButton: false,
    timer: 3000
  });

  var formValidate = $('#addMeasurement').validate({
    debug : true,
    rules: {
      addSensor: {
        required : true
      },
      datepicker: {
        required: true
      },
      description: {
        required: true
      },
      lat: {
        required: true
      },
      lon: {
        required: true
      }
    },
    messages: {
      addSensor: {
        required : "Selecione um sensor"
      },
      datepicker: {
        required: "Defina a data de início"
      },
      description: {
        required: "Descrição da medição"
      },
      lat: {
        required: "Latitude"
      },
      lon: {
        required: "Longitude"
      }
    },
    errorElement: 'span',
    errorPlacement: function (error, element) {
      error.addClass('invalid-feedback');
      element.closest('.form-group').append(error);
    },
    highlight: function (element, errorClass, validClass) {
      $(element).addClass('is-invalid');
    },
    unhighlight: function (element, errorClass, validClass) {
      $(element).removeClass('is-invalid');
    }
  });


  function getUser(){

  }

  function getSensores(){
    axios
        .get("http://localhost:3000/sensor/find/active", {
          headers: { "Content-Type": "application/json" }
        })
        .then(r => { 
            for (var i = 0; i < r.data.length; i++) {
            $('#addSensor').append('<option value=' + r.data[i]["_id"] +'>' + r.data[i]["name"] + '</option>');
                  }
                  })
        .catch(e => toastr.error(e, 'Error', {timeOut: 5000}));
    }

    $("#signout").click(function() {
      localStorage.clear();
      setTimeout(function() {document.location.href = "/cmvc/";}, 500);
    });

    $("#addMeasurement").submit(function(){
      if(!formValidate.valid()) return false;
      

    })
});
</script>


